# 10	ç”¨æˆ·ç™»å½•

## 10.1	ç”¨æˆ·ç™»å½•åŠŸèƒ½çš„å®ç°

##### ä¸€èˆ¬çš„ç”¨æˆ·èº«ä»½éªŒè¯

![img](img/clip_image00224cdfa28-90ef-4c73-911c-cd14f774f04d.gif)

Internet æœåŠ¡æ— æ³•ä¸ç”¨æˆ·èº«ä»½éªŒè¯åˆ†å¼€ã€‚ä¸€èˆ¬è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·å‘æœåŠ¡å™¨å‘é€ç”¨æˆ·åå’Œå¯†ç ã€‚
2. éªŒè¯æœåŠ¡å™¨åï¼Œç›¸å…³æ•°æ®ï¼ˆå¦‚ç”¨æˆ·è§’è‰²ï¼Œç™»å½•æ—¶é—´ç­‰ï¼‰å°†ä¿å­˜åœ¨å½“å‰ä¼šè¯ä¸­ã€‚
3. æœåŠ¡å™¨å‘ç”¨æˆ·è¿”å› session_idï¼Œsession ä¿¡æ¯éƒ½ä¼šå†™å…¥åˆ°ç”¨æˆ·çš„ Cookieã€‚
4. ç”¨æˆ·çš„æ¯ä¸ªåç»­è¯·æ±‚éƒ½å°†é€šè¿‡åœ¨ Cookie ä¸­å–å‡º session_id ä¼ ç»™æœåŠ¡å™¨ã€‚
5. æœåŠ¡å™¨æ”¶åˆ° session_id å¹¶å¯¹æ¯”ä¹‹å‰ä¿å­˜çš„æ•°æ®ï¼Œç¡®è®¤ç”¨æˆ·çš„èº«ä»½ã€‚

###### ç¼ºç‚¹

è¿™ç§æ¨¡å¼æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œæ²¡æœ‰åˆ†å¸ƒå¼æ¶æ„ï¼Œæ— æ³•æ”¯æŒæ¨ªå‘æ‰©å±•

<br>

##### SSOï¼ˆsingle sign onï¼‰æ¨¡å¼

åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸ç”¨ SSO(single sign onï¼Œåˆç§°å•ç‚¹ç™»å½•) æ¨¡å¼å®ç°ç™»å½•åŠŸèƒ½ï¼Œ

![img](img/clip_image0041ce28b5a-5e6d-4943-a794-3f3a93e82737.gif)

###### ä¼˜ç‚¹

ç”¨æˆ·èº«ä»½ä¿¡æ¯ç‹¬ç«‹ç®¡ç†ï¼Œæ›´å¥½çš„åˆ†å¸ƒå¼ç®¡ç†ã€‚

 å¯ä»¥è‡ªå·±æ‰©å±•å®‰å…¨ç­–ç•¥

###### ç¼ºç‚¹

   è®¤è¯æœåŠ¡å™¨è®¿é—®å‹åŠ›è¾ƒå¤§ã€‚

###### å®ç°æ–¹æ¡ˆ

1. **session å¹¿æ’­æœºåˆ¶å®ç°**ï¼šé€šè¿‡ session å¤åˆ¶ã€‚

2. **ä½¿ç”¨ cookie + redis å®ç°**ï¼šåœ¨é¡¹ç›®æŸä¸ªæ¨¡å—è¿›è¡Œç™»å½•ï¼Œç™»å½•ä¹‹åï¼ŒæŠŠæ•°æ®ä¿å­˜åˆ°ä¸¤ä¸ªåœ°æ–¹ï¼š

   - redisï¼šä½¿ç”¨ç”Ÿæˆçš„å”¯ä¸€éšæœºå€¼ï¼ˆIP åœ°å€ã€ç”¨æˆ· id ç­‰ç­‰ï¼‰ä½œä¸ºkeyï¼Œä½¿ç”¨ç”¨æˆ·æ•°æ®ä½œä¸ºvalue
   - cookieï¼šæŠŠ redis é‡Œé¢ç”Ÿæˆ key å€¼æ”¾åˆ° cookie é‡Œé¢

   è®¿é—®é—®é¡¹ç›®ä¸­å…¶ä»–æ¨¡å—æ—¶ï¼Œè¯·æ±‚å¸¦ç€ cookie è¿›è¡Œå‘é€ï¼Œé€šè¿‡ cookie ä¸­çš„ key åˆ° redis è¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚æœæŸ¥è¯¢æˆåŠŸå³å·²ç™»å½•çŠ¶æ€ã€‚

3. **ä½¿ç”¨ token å®ç°**ï¼šåœ¨é¡¹ç›®æŸä¸ªæ¨¡å—è¿›è¡Œç™»å½•ï¼Œç™»å½•ä¹‹åï¼ŒæŒ‰ç…§è§„åˆ™ç”Ÿæˆå­—ç¬¦ä¸²ï¼ŒæŠŠç™»å½•ä¹‹åçš„ç”¨æˆ·ä¿¡æ¯åŒ…å«åˆ°ç”Ÿæˆçš„å­—ç¬¦ä¸²é‡Œé¢ï¼ŒæŠŠå­—ç¬¦ä¸²è¿”å›ã€‚å­—ç¬¦ä¸²å¯ä»¥é€šè¿‡ cookie è¿”å›ï¼Œä¹Ÿå¯ä»¥é€šè¿‡åœ°å€æ è¿”å›ã€‚è®¿é—®é¡¹ç›®å…¶ä»–æ¨¡å—æ—¶ï¼Œåœ¨åœ°å€æ å¸¦ç€ç”Ÿæˆå­—ç¬¦ä¸²ï¼Œå…¶ä»–æ¨¡å—æ ¹æ®å­—ç¬¦ä¸²è·å–ç”¨æˆ·ä¿¡æ¯ã€‚

<br>

----

<div STYLE="page-break-after: always;">
    <br>
	<br>
	<br>
	<br>
	<br>
</div>
## 10.2	JWT

### 10.2.1	JWT æ¦‚è¿°

#####  è®¿é—®ä»¤ç‰Œçš„ç±»å‹

![img](img/4c5b3db1-6052-441b-8384-8800fa4c288a.jpg)

<br>

##### JWT çš„ç»„æˆ

ä¸€ä¸ªå…¸å‹çš„ JWT çœ‹èµ·æ¥å¦‚ä¸‹å›¾ï¼š

![img](img/e3d41db5-686c-4deb-945b-5c6bc76658c3.png)

è¯¥ JWT ä¸ºä¸€ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¹‹é—´é€šè¿‡ `.` åˆ†éš”ç¬¦åˆ†ä¸ºä¸‰ä¸ªå­ä¸²ã€‚æ¯ä¸€ä¸ªå­ä¸²è¡¨ç¤ºäº†ä¸€ä¸ªåŠŸèƒ½å—ï¼Œæ€»å…±æœ‰ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼š

- JWTå¤´
- æœ‰æ•ˆè½½è·
- ç­¾å

###### JWT å¤´

JWTå¤´éƒ¨åˆ†æ˜¯ä¸€ä¸ªæè¿° JWT å…ƒæ•°æ®çš„ JSON å¯¹è±¡ï¼Œé€šå¸¸å¦‚ä¸‹æ‰€ç¤ºã€‚

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œalg å±æ€§è¡¨ç¤ºç­¾åä½¿ç”¨çš„ç®—æ³•ï¼Œé»˜è®¤ä¸º HMAC SHA256ï¼ˆå†™ä¸º HS256ï¼‰ï¼›typ å±æ€§è¡¨ç¤ºä»¤ç‰Œçš„ç±»å‹ï¼ŒJWT ä»¤ç‰Œç»Ÿä¸€å†™ä¸º JWTã€‚æœ€åï¼Œä½¿ç”¨ Base64 URL ç®—æ³•å°†ä¸Šè¿° JSON å¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä¿å­˜ã€‚

###### æœ‰æ•ˆè½½è·

æœ‰æ•ˆè½½è·éƒ¨åˆ†ï¼Œæ˜¯ JWT çš„ä¸»ä½“å†…å®¹éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒåŒ…å«éœ€è¦ä¼ é€’çš„æ•°æ®ã€‚ JWT æŒ‡å®šä¸ƒä¸ªé»˜è®¤å­—æ®µä¾›é€‰æ‹©ã€‚

- **iss**ï¼šå‘è¡Œäºº
- **exp**ï¼šåˆ°æœŸæ—¶é—´
- **sub**ï¼šä¸»é¢˜
- **aud**ï¼šç”¨æˆ·
- **nbf**ï¼šåœ¨æ­¤ä¹‹å‰ä¸å¯ç”¨
- **iat**ï¼šå‘å¸ƒæ—¶é—´
- **jti**ï¼šJWT IDç”¨äºæ ‡è¯†è¯¥JWT

é™¤ä»¥ä¸Šé»˜è®¤å­—æ®µå¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ç§æœ‰å­—æ®µï¼Œå¦‚ä¸‹ä¾‹ï¼š

```json
{
  "sub": "1234567890",
  "name": "Helen",
  "admin": true
}
```

è¯·æ³¨æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹JWTæ˜¯æœªåŠ å¯†çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥è§£è¯»å…¶å†…å®¹ï¼Œå› æ­¤ä¸è¦æ„å»ºéšç§ä¿¡æ¯å­—æ®µï¼Œå­˜æ”¾ä¿å¯†ä¿¡æ¯ï¼Œä»¥é˜²æ­¢ä¿¡æ¯æ³„éœ²ã€‚JSON å¯¹è±¡ä¹Ÿä½¿ç”¨ Base64 URL ç®—æ³•è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä¿å­˜ã€‚

###### ç­¾åå“ˆå¸Œ

ç­¾åå“ˆå¸Œéƒ¨åˆ†æ˜¯å¯¹ä¸Šé¢ä¸¤éƒ¨åˆ†æ•°æ®ç­¾åï¼Œé€šè¿‡æŒ‡å®šçš„ç®—æ³•ç”Ÿæˆå“ˆå¸Œï¼Œä»¥ç¡®ä¿æ•°æ®ä¸ä¼šè¢«ç¯¡æ”¹ã€‚é¦–å…ˆï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªå¯†ç ï¼ˆsecretï¼‰ã€‚è¯¥å¯†ç ä»…ä»…ä¸ºä¿å­˜åœ¨æœåŠ¡å™¨ä¸­ï¼Œå¹¶ä¸”ä¸èƒ½å‘ç”¨æˆ·å…¬å¼€ã€‚ç„¶åï¼Œä½¿ç”¨æ ‡å¤´ä¸­æŒ‡å®šçš„ç­¾åç®—æ³•ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸ºHMAC SHA256ï¼‰æ ¹æ®ä»¥ä¸‹å…¬å¼ç”Ÿæˆç­¾åï¼š

```
HMACSHA256(base64UrlEncode(header) + "." + base64UrlEncode(claims), secret)
```

åœ¨è®¡ç®—å‡ºç­¾åå“ˆå¸Œåï¼ŒJWTå¤´ï¼Œæœ‰æ•ˆè½½è·å’Œç­¾åå“ˆå¸Œçš„ä¸‰ä¸ªéƒ¨åˆ†ç»„åˆæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªéƒ¨åˆ†ç”¨"."åˆ†éš”ï¼Œå°±æ„æˆæ•´ä¸ªJWTå¯¹è±¡ã€‚

###### Base64URLç®—æ³•

å¦‚å‰æ‰€è¿°ï¼ŒJWT å¤´å’Œæœ‰æ•ˆè½½è·åºåˆ—åŒ–çš„ç®—æ³•éƒ½ç”¨åˆ°äº† Base64URLã€‚è¯¥ç®—æ³•å’Œå¸¸è§ Base64 ç®—æ³•ç±»ä¼¼ï¼Œç¨æœ‰å·®åˆ«ã€‚

ä½œä¸ºä»¤ç‰Œçš„ JWT å¯ä»¥æ”¾åœ¨ URL ä¸­ï¼ˆä¾‹å¦‚ api.example/?token=xxxï¼‰ã€‚ Base64 ä¸­ç”¨çš„ä¸‰ä¸ªå­—ç¬¦æ˜¯"+"ï¼Œ"/"å’Œ"="ï¼Œç”±äºåœ¨ URL ä¸­æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œå› æ­¤ Base64URL ä¸­å¯¹ä»–ä»¬åšäº†æ›¿æ¢ï¼š"="å»æ‰ï¼Œ"+"ç”¨"-"æ›¿æ¢ï¼Œ"/"ç”¨"_"æ›¿æ¢ï¼Œè¿™å°±æ˜¯Base64URLç®—æ³•ã€‚

<br>

##### JWTçš„åŸåˆ™

JWTçš„åŸåˆ™æ˜¯åœ¨æœåŠ¡å™¨èº«ä»½éªŒè¯ä¹‹åï¼Œå°†ç”Ÿæˆä¸€ä¸ªJSONå¯¹è±¡å¹¶å°†å…¶å‘é€å›ç”¨æˆ·ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```
{
  "sub": "1234567890",
  "name": "Helen",
  "admin": true
}
```

ä¹‹åï¼Œå½“ç”¨æˆ·ä¸æœåŠ¡å™¨é€šä¿¡æ—¶ï¼Œå®¢æˆ·åœ¨è¯·æ±‚ä¸­å‘å› JSON å¯¹è±¡ã€‚æœåŠ¡å™¨ä»…ä¾èµ–äºè¿™ä¸ªJSONå¯¹è±¡æ¥æ ‡è¯†ç”¨æˆ·ã€‚ä¸ºäº†é˜²æ­¢ç”¨æˆ·ç¯¡æ”¹æ•°æ®ï¼ŒæœåŠ¡å™¨å°†åœ¨ç”Ÿæˆå¯¹è±¡æ—¶æ·»åŠ ç­¾åã€‚æœåŠ¡å™¨ä¸ä¿å­˜ä»»ä½•ä¼šè¯æ•°æ®ï¼Œå³æœåŠ¡å™¨å˜ä¸ºæ— çŠ¶æ€ï¼Œä½¿å…¶æ›´å®¹æ˜“æ‰©å±•ã€‚

<br>

##### JWTçš„ç”¨æ³•

å®¢æˆ·ç«¯æ¥æ”¶æœåŠ¡å™¨è¿”å›çš„JWTï¼Œå°†å…¶å­˜å‚¨åœ¨ Cookie æˆ– localStorage ä¸­ã€‚

æ­¤åï¼Œå®¢æˆ·ç«¯å°†åœ¨ä¸æœåŠ¡å™¨äº¤äº’ä¸­éƒ½ä¼šå¸¦ JWTã€‚å¦‚æœå°†å®ƒå­˜å‚¨åœ¨ Cookie ä¸­ï¼Œå°±å¯ä»¥è‡ªåŠ¨å‘é€ï¼Œä½†æ˜¯ä¸ä¼šè·¨åŸŸï¼Œå› æ­¤ä¸€èˆ¬æ˜¯å°†å®ƒæ”¾å…¥ HTTP è¯·æ±‚çš„ Header Authorization å­—æ®µä¸­ã€‚å½“è·¨åŸŸæ—¶ï¼Œä¹Ÿå¯ä»¥å°† JWT è¢«æ”¾ç½®äº POST è¯·æ±‚çš„æ•°æ®ä¸»ä½“ä¸­ã€‚

<br>

##### JWT ä¼˜ç‚¹ä¸ç¼ºç‚¹

###### ä¼˜ç‚¹

- JWTä¸ä»…å¯ç”¨äºè®¤è¯ï¼Œè¿˜å¯ç”¨äºä¿¡æ¯äº¤æ¢ã€‚å–„ç”¨JWTæœ‰åŠ©äºå‡å°‘æœåŠ¡å™¨è¯·æ±‚æ•°æ®åº“çš„æ¬¡æ•°ã€‚
- ç”Ÿäº§çš„tokenå¯ä»¥åŒ…å«åŸºæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚idã€ç”¨æˆ·æ˜µç§°ã€å¤´åƒç­‰ä¿¡æ¯ï¼Œé¿å…å†æ¬¡æŸ¥åº“
- å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œä¸å ç”¨æœåŠ¡ç«¯çš„å†…å­˜èµ„æº

###### ç¼ºç‚¹

- JWT é»˜è®¤ä¸åŠ å¯†ï¼Œä½†å¯ä»¥åŠ å¯†ã€‚ç”ŸæˆåŸå§‹ä»¤ç‰Œåï¼Œå¯ä»¥å†æ¬¡å¯¹å…¶è¿›è¡ŒåŠ å¯†ã€‚
- å½“ JWT æœªåŠ å¯†æ—¶ï¼Œä¸€äº›ç§å¯†æ•°æ®æ— æ³•é€šè¿‡ JWT ä¼ è¾“ã€‚
- JWT çš„æœ€å¤§ç¼ºç‚¹æ˜¯æœåŠ¡å™¨ä¸ä¿å­˜ä¼šè¯çŠ¶æ€ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æœŸé—´ä¸å¯èƒ½å–æ¶ˆä»¤ç‰Œæˆ–æ›´æ”¹ä»¤ç‰Œçš„æƒé™ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦ JWT ç­¾å‘ï¼Œåœ¨æœ‰æ•ˆæœŸå†…å°†ä¼šä¸€ç›´æœ‰æ•ˆã€‚
- JWT æœ¬èº«åŒ…å«è®¤è¯ä¿¡æ¯ï¼Œtoken æ˜¯ç»è¿‡ base64 ç¼–ç ï¼Œæ‰€ä»¥å¯ä»¥è§£ç ï¼Œå› æ­¤ token åŠ å¯†å‰çš„å¯¹è±¡ä¸åº”è¯¥åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œä¸€æ—¦ä¿¡æ¯æ³„éœ²ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å¾—ä»¤ç‰Œçš„æ‰€æœ‰æƒé™ã€‚ä¸ºäº†å‡å°‘ç›—ç”¨ï¼ŒJWTçš„æœ‰æ•ˆæœŸä¸å®œè®¾ç½®å¤ªé•¿ã€‚å¯¹äºæŸäº›é‡è¦æ“ä½œï¼Œç”¨æˆ·åœ¨ä½¿ç”¨æ—¶åº”è¯¥æ¯æ¬¡éƒ½è¿›è¡Œè¿›è¡Œèº«ä»½éªŒè¯ã€‚
- ä¸ºäº†å‡å°‘ç›—ç”¨å’Œçªƒå–ï¼ŒJWTä¸å»ºè®®ä½¿ç”¨ HTTP åè®®æ¥ä¼ è¾“ä»£ç ï¼Œè€Œæ˜¯ä½¿ç”¨åŠ å¯†çš„ HTTPS åè®®è¿›è¡Œä¼ è¾“ã€‚

<br>

---

<div STYLE="page-break-after: always;">
    <br>
	<br>
	<br>
	<br>
	<br>
</div>

### 10.2.2	åœ¨é¡¹ç›®ä¸­æ•´åˆ JWT ä»¤ç‰Œ

##### æ­¥éª¤

###### ç¬¬ä¸€æ­¥

åœ¨ common_utils æ¨¡å—ä¸­æ·»åŠ  jwt å·¥å…·ä¾èµ–

```xml
<!-- JWT-->
<dependency>
	<groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>${jjwt-api.version}</version>
</dependency>
```

###### ç¬¬äºŒæ­¥

åœ¨ common_utils æ¨¡å—ä¸­åˆ›å»º JWT å·¥å…·ç±»

```
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jws;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import org.springframework.util.StringUtils;
import javax.servlet.http.HttpServletRequest;
import java.util.Date;
/**
 * @author
 */
public class JwtUtils {
    public static final long EXPIRE = 1000 * 60 * 60 * 24;
    public static final String APP_SECRET = "ukc8BDbRigUDaY6pZFfWus2jZWLPHO";
    public static String getJwtToken(String id, String nickname){
        String JwtToken = Jwts.builder()
                .setHeaderParam("typ", "JWT")
                .setHeaderParam("alg", "HS256")
                .setSubject("guli-user")
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRE))
                .claim("id", id)
                .claim("nickname", nickname)
                .signWith(SignatureAlgorithm.HS256, APP_SECRET)
                .compact();
        return JwtToken;
    }
    /**
     * åˆ¤æ–­tokenæ˜¯å¦å­˜åœ¨ä¸æœ‰æ•ˆ
     * @param jwtToken
     * @return
     */
    public static boolean checkToken(String jwtToken) {
        if(StringUtils.isEmpty(jwtToken)) return false;
        try {
            Jwts.parser().setSigningKey(APP_SECRET).parseClaimsJws(jwtToken);
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
        return true;
    }
    /**
     * åˆ¤æ–­tokenæ˜¯å¦å­˜åœ¨ä¸æœ‰æ•ˆ
     * @param request
     * @return
     */
    public static boolean checkToken(HttpServletRequest request) {
        try {
            String jwtToken = request.getHeader("token");
            if(StringUtils.isEmpty(jwtToken)) return false;
            Jwts.parser().setSigningKey(APP_SECRET).parseClaimsJws(jwtToken);
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
        return true;
    }
    /**
     * æ ¹æ®tokenè·å–ä¼šå‘˜id
     * @param request
     * @return
     */
    public static String getMemberIdByJwtToken(HttpServletRequest request) {
        String jwtToken = request.getHeader("token");
        if(StringUtils.isEmpty(jwtToken)) return "";
        Jws<Claims> claimsJws = Jwts.parser().setSigningKey(APP_SECRET).parseClaimsJws(jwtToken);
        Claims claims = claimsJws.getBody();
        return (String)claims.get("id");
    }
}
```

<br>

---

<div STYLE="page-break-after: always;">
    <br>
	<br>
	<br>
	<br>
	<br>
</div>
## 10.3	é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡ï¼ˆéœ€è¦ä¼ä¸šè®¤è¯ï¼‰

<br>

----

<div STYLE="page-break-after: always;">
    <br>
	<br>
	<br>
	<br>
	<br>
</div>
## 10.4	é‚®ç®±éªŒè¯

#### 10.4.1	é€šè¿‡ org.apache.commonsçš„commons-email å®ç°

##### ä¾èµ–

```
    <!-- https://mvnrepository.com/artifact/org.apache.commons/commons-email -->
    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-email</artifactId>
        <version>1.5</version>
    </dependency>
```

<br>

---

<div STYLE="page-break-after: always;">
    <br>
	<br>
	<br>
	<br>
	<br>
</div>
## 10.5	ç™»å½•åŠŸèƒ½å…·ä½“å®ç°

### 10.5.1	åç«¯å®ç°

<br>

---

<div STYLE="page-break-after: always;">
    <br>
	<br>
	<br>
	<br>
	<br>
</div>

### 10.5.2	å‰ç«¯å®ç°

<br>

---

<div STYLE="page-break-after: always;">
    <br>
	<br>
	<br>
	<br>
	<br>
</div>

## 10.6	OAuth2

### 10.6.1	OAuth2 æ¦‚è¿°

![img](img/78c5ad4f-b313-480c-b2af-8498ef731e35.jpg)

<br>

##### ä»¤ç‰Œçš„æ ¸å¿ƒ

![img](img/6558a8b7-022f-4649-963b-85a2ec17099e.jpg)

<br>

##### OAuth2 çš„å†å²

![img](img/1e1960bc-c516-4308-95e9-6fd34fed052b.png)

<br>

##### OAuth2çš„ä¼˜åŠ¿

![img](img/6afb4072-f7bd-48bb-b67a-e08528ade728.jpg)

<br>

##### OAuth2çš„ä¸è¶³

![img](img/8d5abdef-dcdc-4414-827c-5d30bc60c459.jpg)

<br>

##### OAuth2 æ¶‰åŠçš„è§’è‰²

![img](img/c40e403f-3824-4867-b341-d31aca003d9e.jpg)

<br>

##### OAuth2 æœ¯è¯­

![img](img/c00b40aa-41c5-4c86-ae62-d6f4955f1522.png)

<br>

##### OAuth2 ä»¤ç‰Œçš„ç±»å‹

![img](img/7f83735b-9b05-48b9-ad16-5e314e7a1da1.jpg)

<br>

##### OAuth2 çš„è¯¯è§£

![img](img/e816e3f7-826a-43b8-8379-f86db8e25205.jpg)

<br>

##### OAuth2 æå‡ºçš„èƒŒæ™¯

ç…§ç‰‡æ‹¥æœ‰è€…æƒ³è¦åœ¨äº‘å†²å°æœåŠ¡ä¸Šæ‰“å°ç…§ç‰‡ï¼Œäº‘å†²å°æœåŠ¡éœ€è¦è®¿é—®äº‘å­˜å‚¨æœåŠ¡ä¸Šçš„èµ„æº

![img](img/100bc1f9-5d9e-4600-9b2b-e3eb7ad7d9c5-16412074989111.jpg)

###### å›¾ä¾‹

èµ„æºæ‹¥æœ‰è€…ï¼šç…§ç‰‡æ‹¥æœ‰è€…

å®¢æˆ·åº”ç”¨ï¼šäº‘å†²å°

å—ä¿æŠ¤çš„èµ„æºï¼šç…§ç‰‡

![img](img/f1b879ec-1c76-42bc-991b-d68c140b4e49-16412075100772.jpg)

###### æ–¹å¼ä¸€ï¼šç”¨æˆ·åå¯†ç å¤åˆ¶

é€‚ç”¨äºåŒä¸€å…¬å¸å†…éƒ¨çš„å¤šä¸ªç³»ç»Ÿï¼Œä¸é€‚ç”¨äºä¸å—ä¿¡çš„ç¬¬ä¸‰æ–¹åº”ç”¨

![img](img/f57f30af-3bdd-4c5d-b4d3-f934b4f9f608.jpg)

###### æ–¹å¼äºŒï¼šé€šç”¨å¼€å‘è€…key

é€‚ç”¨äºåˆä½œå•†æˆ–è€…æˆä¿¡çš„ä¸åŒä¸šåŠ¡éƒ¨é—¨ä¹‹é—´

![img](img/959b118f-62e0-452c-bcbe-6ba6e6c5f9af.jpg)

###### æ–¹å¼ä¸‰ï¼šåŠæ³•ä»¤ç‰Œ

æ¥è¿‘ OAuth2 æ–¹å¼ï¼Œéœ€è¦è€ƒè™‘å¦‚ä½•ç®¡ç†ä»¤ç‰Œã€é¢å‘ä»¤ç‰Œã€åŠé”€ä»¤ç‰Œï¼Œéœ€è¦ç»Ÿä¸€çš„åè®®ï¼Œå› æ­¤å°±æœ‰äº† OAuth2 åè®®

![img](img/e6c08180-79bc-4804-8c7b-e371ab168bb5.jpg)

<br>

##### ç°ä»£å¾®æœåŠ¡å®‰å…¨

é™¤äº†å¼€æ”¾ç³»ç»Ÿæˆæƒï¼ŒOAuth2è¿˜å¯ä»¥åº”ç”¨äºç°ä»£å¾®æœåŠ¡å®‰å…¨

###### ä¼ ç»Ÿå•å—åº”ç”¨çš„å®‰å…¨

![img](img/5fe36f0a-23e9-44b7-bf2d-19d694d47b7b.jpg)

###### ç°ä»£å¾®æœåŠ¡å®‰å…¨

ç°ä»£å¾®æœåŠ¡ä¸­ç³»ç»Ÿå¾®æœåŠ¡åŒ–ä»¥åŠåº”ç”¨çš„å½¢æ€å’Œè®¾å¤‡ç±»å‹å¢å¤šï¼Œä¸èƒ½ç”¨ä¼ ç»Ÿçš„ç™»å½•æ–¹å¼

æ ¸å¿ƒçš„æŠ€æœ¯ä¸æ˜¯ç”¨æˆ·åå’Œå¯†ç ï¼Œè€Œæ˜¯tokenï¼Œç”±AuthServeré¢å‘tokenï¼Œç”¨æˆ·ä½¿ç”¨tokenè¿›è¡Œç™»å½•

![img](img/0795984b-635b-478f-96c6-c48872e59fb6.jpg)

<br>

##### å…¸å‹çš„ OAuth2 åº”ç”¨

- æ‰«ç ç™»å½•
- ç¬¬ä¸‰æ–¹æˆæƒç™»å½•

<br>

##### æ€»ç»“

![img](img/0378fb81-a658-42d5-aac4-d006bb1c66b5.jpg)

<br>

---

<div STYLE="page-break-after: always;">
    <br>
	<br>
	<br>
	<br>
	<br>
</div>

### 10.6.2	å®ç°å¾®ä¿¡ OAuth2 ç™»å½•

##### å‰ææ¡ä»¶

- å¾®ä¿¡å¼€å‘è€…èµ„è´¨è®¤è¯ï¼ˆéœ€è¦è¥ä¸šæ‰§ç…§ã€å®¡æ‰¹æ—¶é—´ä»¥åŠæ³¨å†Œè´¹ï¼‰
- å¾®ä¿¡å¼€æ”¾å¹³å° appid
- å¾®ä¿¡å¼€æ”¾å¹³å° appsecret
- å¾®ä¿¡å¼€æ”¾å¹³å° é‡å®šå‘url

```properties
# å¾®ä¿¡å¼€æ”¾å¹³å° appid
wx.open.app_id=ä½ çš„appid
# å¾®ä¿¡å¼€æ”¾å¹³å° appsecret
wx.open.app_secret=ä½ çš„appsecret
# å¾®ä¿¡å¼€æ”¾å¹³å° é‡å®šå‘url
wx.open.redirect_url=http://ä½ çš„æœåŠ¡å™¨åç§°/api/ucenter/wx/callback
```

<br>

##### ä¾èµ–

```xml
    <dependencies>

        <!--httpclient-->
        <dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpclient</artifactId>
        </dependency>
        <!--commons-io-->
        <dependency>
            <groupId>commons-io</groupId>
            <artifactId>commons-io</artifactId>
        </dependency>
        <!--å¯ä»¥ä½¿ç”¨ SpringBoot é»˜è®¤çš„ json è§£æå™¨-->
        <dependency>
            <groupId>com.google.code.gson</groupId>
            <artifactId>gson</artifactId>
        </dependency>
    </dependencies>
```

<br>

##### æ­¥éª¤

###### ç¬¬ä¸€æ­¥

åˆ›å»ºå·¥å…·ç±»è¯»å–é…ç½®æ–‡ä»¶ï¼š

```java
import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

@Component
public class ConstantWxUtils implements InitializingBean {

    @Value("${wx.open.app_id}")
    private String appId;

    @Value("${wx.open.app_secret}")
    private String appSecret;

    @Value("${wx.open.redirect_url}")
    private String redirectUrl;

    public static String WX_OPEN_APP_ID;
    public static String WX_OPEN_APP_SECRET;
    public static String WX_OPEN_REDIRECT_URL;

    @Override
    public void afterPropertiesSet() throws Exception {
        WX_OPEN_APP_ID = appId;
        WX_OPEN_APP_SECRET = appSecret;
        WX_OPEN_REDIRECT_URL = redirectUrl;
    }
}
```

######  ç¬¬äºŒæ­¥ğŸ“Œï¼ˆä¹Ÿè®¸å¯ä»¥é€šè¿‡ Feign å®ç°ï¼‰

åˆ›å»º HttpClientUtils å·¥å…·ç±»

```java
package cn.nilnullnaught.educenter.util;

import org.apache.commons.io.IOUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.http.Consts;
import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.NameValuePair;
import org.apache.http.client.HttpClient;
import org.apache.http.client.config.RequestConfig;
import org.apache.http.client.config.RequestConfig.Builder;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.conn.ConnectTimeoutException;
import org.apache.http.conn.ssl.SSLConnectionSocketFactory;
import org.apache.http.conn.ssl.SSLContextBuilder;
import org.apache.http.conn.ssl.TrustStrategy;
import org.apache.http.conn.ssl.X509HostnameVerifier;
import org.apache.http.entity.ContentType;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.impl.conn.PoolingHttpClientConnectionManager;
import org.apache.http.message.BasicNameValuePair;

import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLException;
import javax.net.ssl.SSLSession;
import javax.net.ssl.SSLSocket;
import java.io.IOException;
import java.net.SocketTimeoutException;
import java.security.GeneralSecurityException;
import java.security.cert.CertificateException;
import java.security.cert.X509Certificate;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

/**
 *  ä¾èµ–çš„jaråŒ…æœ‰ï¼šcommons-lang-2.6.jarã€httpclient-4.3.2.jarã€httpcore-4.3.1.jarã€commons-io-2.4.jar
 * @author zhaoyb
 *
 */
public class HttpClientUtils {

    public static final int connTimeout=10000;
    public static final int readTimeout=10000;
    public static final String charset="UTF-8";
    private static HttpClient client = null;

    static {
        PoolingHttpClientConnectionManager cm = new PoolingHttpClientConnectionManager();
        cm.setMaxTotal(128);
        cm.setDefaultMaxPerRoute(128);
        client = HttpClients.custom().setConnectionManager(cm).build();
    }

    public static String postParameters(String url, String parameterStr) throws ConnectTimeoutException, SocketTimeoutException, Exception{
        return post(url,parameterStr,"application/x-www-form-urlencoded",charset,connTimeout,readTimeout);
    }

    public static String postParameters(String url, String parameterStr,String charset, Integer connTimeout, Integer readTimeout) throws ConnectTimeoutException, SocketTimeoutException, Exception{
        return post(url,parameterStr,"application/x-www-form-urlencoded",charset,connTimeout,readTimeout);
    }

    public static String postParameters(String url, Map<String, String> params) throws ConnectTimeoutException,
            SocketTimeoutException, Exception {
        return postForm(url, params, null, connTimeout, readTimeout);
    }

    public static String postParameters(String url, Map<String, String> params, Integer connTimeout,Integer readTimeout) throws ConnectTimeoutException,
            SocketTimeoutException, Exception {
        return postForm(url, params, null, connTimeout, readTimeout);
    }

    public static String get(String url) throws Exception {
        return get(url, charset, null, null);
    }

    public static String get(String url, String charset) throws Exception {
        return get(url, charset, connTimeout, readTimeout);
    }

    /**
     * å‘é€ä¸€ä¸ª Post è¯·æ±‚, ä½¿ç”¨æŒ‡å®šçš„å­—ç¬¦é›†ç¼–ç .
     *
     * @param url
     * @param body RequestBody
     * @param mimeType ä¾‹å¦‚ application/xml "application/x-www-form-urlencoded" a=1&b=2&c=3
     * @param charset ç¼–ç 
     * @param connTimeout å»ºç«‹é“¾æ¥è¶…æ—¶æ—¶é—´,æ¯«ç§’.
     * @param readTimeout å“åº”è¶…æ—¶æ—¶é—´,æ¯«ç§’.
     * @return ResponseBody, ä½¿ç”¨æŒ‡å®šçš„å­—ç¬¦é›†ç¼–ç .
     * @throws ConnectTimeoutException å»ºç«‹é“¾æ¥è¶…æ—¶å¼‚å¸¸
     * @throws SocketTimeoutException  å“åº”è¶…æ—¶
     * @throws Exception
     */
    public static String post(String url, String body, String mimeType,String charset, Integer connTimeout, Integer readTimeout)
            throws ConnectTimeoutException, SocketTimeoutException, Exception {
        HttpClient client = null;
        HttpPost post = new HttpPost(url);
        String result = "";
        try {
            if (StringUtils.isNotBlank(body)) {
                HttpEntity entity = new StringEntity(body, ContentType.create(mimeType, charset));
                post.setEntity(entity);
            }
            // è®¾ç½®å‚æ•°
            Builder customReqConf = RequestConfig.custom();
            if (connTimeout != null) {
                customReqConf.setConnectTimeout(connTimeout);
            }
            if (readTimeout != null) {
                customReqConf.setSocketTimeout(readTimeout);
            }
            post.setConfig(customReqConf.build());

            HttpResponse res;
            if (url.startsWith("https")) {
                // æ‰§è¡Œ Https è¯·æ±‚.
                client = createSSLInsecureClient();
                res = client.execute(post);
            } else {
                // æ‰§è¡Œ Http è¯·æ±‚.
                client = HttpClientUtils.client;
                res = client.execute(post);
            }
            result = IOUtils.toString(res.getEntity().getContent(), charset);
        } finally {
            post.releaseConnection();
            if (url.startsWith("https") && client != null&& client instanceof CloseableHttpClient) {
                ((CloseableHttpClient) client).close();
            }
        }
        return result;
    }


    /**
     * æäº¤formè¡¨å•
     *
     * @param url
     * @param params
     * @param connTimeout
     * @param readTimeout
     * @return
     * @throws ConnectTimeoutException
     * @throws SocketTimeoutException
     * @throws Exception
     */
    public static String postForm(String url, Map<String, String> params, Map<String, String> headers, Integer connTimeout,Integer readTimeout) throws ConnectTimeoutException,
            SocketTimeoutException, Exception {

        HttpClient client = null;
        HttpPost post = new HttpPost(url);
        try {
            if (params != null && !params.isEmpty()) {
                List<NameValuePair> formParams = new ArrayList<NameValuePair>();
                Set<Entry<String, String>> entrySet = params.entrySet();
                for (Entry<String, String> entry : entrySet) {
                    formParams.add(new BasicNameValuePair(entry.getKey(), entry.getValue()));
                }
                UrlEncodedFormEntity entity = new UrlEncodedFormEntity(formParams, Consts.UTF_8);
                post.setEntity(entity);
            }

            if (headers != null && !headers.isEmpty()) {
                for (Entry<String, String> entry : headers.entrySet()) {
                    post.addHeader(entry.getKey(), entry.getValue());
                }
            }
            // è®¾ç½®å‚æ•°
            Builder customReqConf = RequestConfig.custom();
            if (connTimeout != null) {
                customReqConf.setConnectTimeout(connTimeout);
            }
            if (readTimeout != null) {
                customReqConf.setSocketTimeout(readTimeout);
            }
            post.setConfig(customReqConf.build());
            HttpResponse res = null;
            if (url.startsWith("https")) {
                // æ‰§è¡Œ Https è¯·æ±‚.
                client = createSSLInsecureClient();
                res = client.execute(post);
            } else {
                // æ‰§è¡Œ Http è¯·æ±‚.
                client = HttpClientUtils.client;
                res = client.execute(post);
            }
            return IOUtils.toString(res.getEntity().getContent(), "UTF-8");
        } finally {
            post.releaseConnection();
            if (url.startsWith("https") && client != null
                    && client instanceof CloseableHttpClient) {
                ((CloseableHttpClient) client).close();
            }
        }
    }




    /**
     * å‘é€ä¸€ä¸ª GET è¯·æ±‚
     *
     * @param url
     * @param charset
     * @param connTimeout  å»ºç«‹é“¾æ¥è¶…æ—¶æ—¶é—´,æ¯«ç§’.
     * @param readTimeout  å“åº”è¶…æ—¶æ—¶é—´,æ¯«ç§’.
     * @return
     * @throws ConnectTimeoutException   å»ºç«‹é“¾æ¥è¶…æ—¶
     * @throws SocketTimeoutException   å“åº”è¶…æ—¶
     * @throws Exception
     */
    public static String get(String url, String charset, Integer connTimeout,Integer readTimeout)
            throws ConnectTimeoutException,SocketTimeoutException, Exception {

        HttpClient client = null;
        HttpGet get = new HttpGet(url);
        String result = "";
        try {
            // è®¾ç½®å‚æ•°
            Builder customReqConf = RequestConfig.custom();
            if (connTimeout != null) {
                customReqConf.setConnectTimeout(connTimeout);
            }
            if (readTimeout != null) {
                customReqConf.setSocketTimeout(readTimeout);
            }
            get.setConfig(customReqConf.build());

            HttpResponse res = null;

            if (url.startsWith("https")) {
                // æ‰§è¡Œ Https è¯·æ±‚.
                client = createSSLInsecureClient();
                res = client.execute(get);
            } else {
                // æ‰§è¡Œ Http è¯·æ±‚.
                client = HttpClientUtils.client;
                res = client.execute(get);
            }

            result = IOUtils.toString(res.getEntity().getContent(), charset);
        } finally {
            get.releaseConnection();
            if (url.startsWith("https") && client != null && client instanceof CloseableHttpClient) {
                ((CloseableHttpClient) client).close();
            }
        }
        return result;
    }


    /**
     * ä» response é‡Œè·å– charset
     *
     * @param ressponse
     * @return
     */
    @SuppressWarnings("unused")
    private static String getCharsetFromResponse(HttpResponse ressponse) {
        // Content-Type:text/html; charset=GBK
        if (ressponse.getEntity() != null  && ressponse.getEntity().getContentType() != null && ressponse.getEntity().getContentType().getValue() != null) {
            String contentType = ressponse.getEntity().getContentType().getValue();
            if (contentType.contains("charset=")) {
                return contentType.substring(contentType.indexOf("charset=") + 8);
            }
        }
        return null;
    }



    /**
     * åˆ›å»º SSLè¿æ¥
     * @return
     * @throws GeneralSecurityException
     */
    private static CloseableHttpClient createSSLInsecureClient() throws GeneralSecurityException {
        try {
            SSLContext sslContext = new SSLContextBuilder().loadTrustMaterial(null, new TrustStrategy() {
                public boolean isTrusted(X509Certificate[] chain,String authType) throws CertificateException {
                    return true;
                }
            }).build();

            SSLConnectionSocketFactory sslsf = new SSLConnectionSocketFactory(sslContext, new X509HostnameVerifier() {

                @Override
                public boolean verify(String arg0, SSLSession arg1) {
                    return true;
                }

                @Override
                public void verify(String host, SSLSocket ssl)
                        throws IOException {
                }

                @Override
                public void verify(String host, X509Certificate cert)
                        throws SSLException {
                }

                @Override
                public void verify(String host, String[] cns,
                                   String[] subjectAlts) throws SSLException {
                }

            });

            return HttpClients.custom().setSSLSocketFactory(sslsf).build();

        } catch (GeneralSecurityException e) {
            throw e;
        }
    }
    
    //æµ‹è¯•
    public static void main(String[] args) {
        try {
            String str= post("https://localhost:443/ssl/test.shtml","name=12&page=34","application/x-www-form-urlencoded", "UTF-8", 10000, 10000);
            //String str= get("https://localhost:443/ssl/test.shtml?name=12&page=34","GBK");
            /*Map<String,String> map = new HashMap<String,String>();
            map.put("name", "111");
            map.put("page", "222");
            String str= postForm("https://localhost:443/ssl/test.shtml",map,null, 10000, 10000);*/
            System.out.println(str);
        } catch (ConnectTimeoutException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        } catch (SocketTimeoutException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        } catch (Exception e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
    }

}

```

###### ç¬¬ä¸‰æ­¥

åˆ›å»º controller

```java
import com.atguigu.commonutils.JwtUtils;
import com.atguigu.educenter.entity.UcenterMember;
import com.atguigu.educenter.service.UcenterMemberService;
import com.atguigu.educenter.utils.ConstantWxUtils;
import com.atguigu.educenter.utils.HttpClientUtils;
import com.atguigu.servicebase.exceptionhandler.GuliException;
import com.google.gson.Gson;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;

import java.net.URLEncoder;
import java.util.HashMap;

@CrossOrigin
@Controller  //åªæ˜¯è¯·æ±‚åœ°å€ï¼Œä¸éœ€è¦è¿”å›æ•°æ®ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨ @RestController
@RequestMapping("/api/wx")
public class WxApiController {

    @Autowired
    private UcenterMemberService memberService;
    
     //ç”Ÿæˆå¾®ä¿¡æ‰«æäºŒç»´ç 
    @GetMapping("login")
    public String getWxCode() {
        //å›ºå®šåœ°å€ï¼Œåé¢æ‹¼æ¥å‚æ•°
//        String url = "https://open.weixin.qq.com/" +
//                "connect/qrconnect?appid="+ ConstantWxUtils.WX_OPEN_APP_ID+"&response_type=code";

        // å¾®ä¿¡å¼€æ”¾å¹³å°æˆæƒbaseUrl  %sç›¸å½“äº?ä»£è¡¨å ä½ç¬¦
        String baseUrl = "https://open.weixin.qq.com/connect/qrconnect" +
                "?appid=%s" +
                "&redirect_uri=%s" +
                "&response_type=code" +
                "&scope=snsapi_login" +
                "&state=%s" +
                "#wechat_redirect";

        //å¯¹redirect_urlè¿›è¡ŒURLEncoderç¼–ç 
        String redirectUrl = ConstantWxUtils.WX_OPEN_REDIRECT_URL;
        try {
            redirectUrl = URLEncoder.encode(redirectUrl, "utf-8");
        }catch(Exception e) {
        }
        
        // é˜²æ­¢csrfæ”»å‡»ï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»ï¼‰
        //ä¸€èˆ¬æƒ…å†µä¸‹ä¼šä½¿ç”¨ä¸€ä¸ªéšæœºæ•°
		//String state = UUID.randomUUID().toString().replaceAll("-", "");
        //ä¸ºäº†è®©å¤§å®¶èƒ½å¤Ÿä½¿ç”¨æˆ‘æ­å»ºçš„å¤–ç½‘çš„å¾®ä¿¡å›è°ƒè·³è½¬æœåŠ¡å™¨,è¿™é‡Œå¡«å†™ä½ åœ¨ngrokçš„å‰ç½®åŸŸå
		String state = "atguigu"

        //è®¾ç½®%sé‡Œé¢å€¼
        String url = String.format(
                    baseUrl,
                    ConstantWxUtils.WX_OPEN_APP_ID,
                    redirectUrl,
                    state
                 );

        //é‡å®šå‘åˆ°è¯·æ±‚å¾®ä¿¡åœ°å€é‡Œé¢
        return "redirect:"+url;
    }

    //å›è°ƒï¼Œè·å–æ‰«æäººä¿¡æ¯ï¼Œæ·»åŠ æ•°æ®
    @GetMapping("callback")
    public String callback(String code, String state) {
        try {
            //1 è·å–codeå€¼ï¼Œä¸´æ—¶ç¥¨æ®ï¼Œç±»ä¼¼äºéªŒè¯ç 
            //2 æ‹¿ç€codeè¯·æ±‚ å¾®ä¿¡å›ºå®šçš„åœ°å€ï¼Œå¾—åˆ°ä¸¤ä¸ªå€¼ accsess_token å’Œ openid
            String baseAccessTokenUrl = "https://api.weixin.qq.com/sns/oauth2/access_token" +
                    "?appid=%s" +
                    "&secret=%s" +
                    "&code=%s" +
                    "&grant_type=authorization_code";
            //æ‹¼æ¥ä¸‰ä¸ªå‚æ•° ï¼šid  ç§˜é’¥ å’Œ codeå€¼
            String accessTokenUrl = String.format(
                    baseAccessTokenUrl,
                    ConstantWxUtils.WX_OPEN_APP_ID,
                    ConstantWxUtils.WX_OPEN_APP_SECRET,
                    code
            );
            //è¯·æ±‚è¿™ä¸ªæ‹¼æ¥å¥½çš„åœ°å€ï¼Œå¾—åˆ°è¿”å›ä¸¤ä¸ªå€¼ accsess_token å’Œ openid
            //ä½¿ç”¨httpclientå‘é€è¯·æ±‚ï¼Œå¾—åˆ°è¿”å›ç»“æœ
            String accessTokenInfo = HttpClientUtils.get(accessTokenUrl);

            //ä»accessTokenInfoå­—ç¬¦ä¸²è·å–å‡ºæ¥ä¸¤ä¸ªå€¼ accsess_token å’Œ openid
            //æŠŠaccessTokenInfoå­—ç¬¦ä¸²è½¬æ¢mapé›†åˆï¼Œæ ¹æ®mapé‡Œé¢keyè·å–å¯¹åº”å€¼
            //ä½¿ç”¨jsonè½¬æ¢å·¥å…· Gson
            Gson gson = new Gson();
            HashMap mapAccessToken = gson.fromJson(accessTokenInfo, HashMap.class);
            String access_token = (String)mapAccessToken.get("access_token");
            String openid = (String)mapAccessToken.get("openid");

            //æŠŠæ‰«æäººä¿¡æ¯æ·»åŠ æ•°æ®åº“é‡Œé¢
            //åˆ¤æ–­æ•°æ®è¡¨é‡Œé¢æ˜¯å¦å­˜åœ¨ç›¸åŒå¾®ä¿¡ä¿¡æ¯ï¼Œæ ¹æ®openidåˆ¤æ–­
            UcenterMember member = memberService.getOpenIdMember(openid);
            if(member == null) {//memeberæ˜¯ç©ºï¼Œè¡¨æ²¡æœ‰ç›¸åŒå¾®ä¿¡æ•°æ®ï¼Œè¿›è¡Œæ·»åŠ 

                //3 æ‹¿ç€å¾—åˆ°accsess_token å’Œ openidï¼Œå†å»è¯·æ±‚å¾®ä¿¡æä¾›å›ºå®šçš„åœ°å€ï¼Œè·å–åˆ°æ‰«æäººä¿¡æ¯
                //è®¿é—®å¾®ä¿¡çš„èµ„æºæœåŠ¡å™¨ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
                String baseUserInfoUrl = "https://api.weixin.qq.com/sns/userinfo" +
                        "?access_token=%s" +
                        "&openid=%s";
                //æ‹¼æ¥ä¸¤ä¸ªå‚æ•°
                String userInfoUrl = String.format(
                        baseUserInfoUrl,
                        access_token,
                        openid
                );
                //å‘é€è¯·æ±‚
                String userInfo = HttpClientUtils.get(userInfoUrl);
                //è·å–è¿”å›userinfoå­—ç¬¦ä¸²æ‰«æäººä¿¡æ¯
                HashMap userInfoMap = gson.fromJson(userInfo, HashMap.class);
                String nickname = (String)userInfoMap.get("nickname");//æ˜µç§°
                String headimgurl = (String)userInfoMap.get("headimgurl");//å¤´åƒ

                member = new UcenterMember();
                member.setOpenid(openid);
                member.setNickname(nickname);
                member.setAvatar(headimgurl);
                memberService.save(member);
            }

            //ä½¿ç”¨jwtæ ¹æ®memberå¯¹è±¡ç”Ÿæˆtokenå­—ç¬¦ä¸²
            String jwtToken = JwtUtils.getJwtToken(member.getId(), member.getNickname());
            //æœ€åï¼šè¿”å›é¦–é¡µé¢ï¼Œé€šè¿‡è·¯å¾„ä¼ é€’tokenå­—ç¬¦ä¸²
            return "redirect:http://localhost:3000?token="+jwtToken;
        }catch(Exception e) {
            throw new GuliException(20001,"ç™»å½•å¤±è´¥");
        }
    }

   
}
```

Servi

```java
@Service
public class UcenterMemberServiceImpl extends ServiceImpl<UcenterMemberMapper, UcenterMember> implements UcenterMemberService {

	...

	@Override
    public UcenterMember getOpenIdMember(String openid) {
        QueryWrapper<UcenterMember> wrapper = new QueryWrapper<>();
        wrapper.eq("openid",openid);
        UcenterMember member = baseMapper.selectOne(wrapper);
        return member;
    }
}
```

æˆæƒ url å‚æ•°è¯´æ˜

| å‚æ•°          | æ˜¯å¦å¿…é¡» | è¯´æ˜                                                         |
| ------------- | -------- | ------------------------------------------------------------ |
| appid         | æ˜¯       | åº”ç”¨å”¯ä¸€æ ‡è¯†                                                 |
| redirect_uri  | æ˜¯       | è¯·ä½¿ç”¨urlEncodeå¯¹é“¾æ¥è¿›è¡Œå¤„ç†                                |
| response_type | æ˜¯       | å¡«code                                                       |
| scope         | æ˜¯       | åº”ç”¨æˆæƒä½œç”¨åŸŸï¼Œæ‹¥æœ‰å¤šä¸ªä½œç”¨åŸŸç”¨é€—å·ï¼ˆ,ï¼‰åˆ†éš”ï¼Œç½‘é¡µåº”ç”¨ç›®å‰ä»…å¡«å†™snsapi_loginå³ |
| state         | å¦       | ç”¨äºä¿æŒè¯·æ±‚å’Œå›è°ƒçš„çŠ¶æ€ï¼Œæˆæƒè¯·æ±‚ååŸæ ·å¸¦å›ç»™ç¬¬ä¸‰æ–¹ã€‚è¯¥å‚æ•°å¯ç”¨äºé˜²æ­¢csrfæ”»å‡»ï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»ï¼‰ï¼Œå»ºè®®ç¬¬ä¸‰æ–¹å¸¦ä¸Šè¯¥å‚æ•°ï¼Œå¯è®¾ç½®ä¸ºç®€å•çš„éšæœºæ•°åŠ sessionè¿›è¡Œæ ¡éªŒ |

<br>



---

