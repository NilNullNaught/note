# 8	è‡ªåŠ¨è¡¥å…¨

## 8.1	è‡ªåŠ¨è¡¥å…¨æ¦‚è¿°

##### ä»€ä¹ˆæ˜¯è‡ªåŠ¨è¡¥å…¨

â€‹	å½“ç”¨æˆ·åœ¨æœç´¢æ¡†è¾“å…¥å­—ç¬¦æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æç¤ºå‡ºä¸è¯¥å­—ç¬¦æœ‰å…³çš„æœç´¢é¡¹ï¼Œå¦‚å›¾ï¼š

![image-20210723204936367](img/8.1-1.png)

è¿™ç§æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å­—æ¯ï¼Œæç¤ºå®Œæ•´è¯æ¡çš„åŠŸèƒ½ï¼Œå°±æ˜¯è‡ªåŠ¨è¡¥å…¨äº†ã€‚

<br>

##### æ‹¼éŸ³åˆ†è¯å™¨

è¦å®ç°æ ¹æ®å­—æ¯åšè¡¥å…¨ï¼Œå°±å¿…é¡»å¯¹æ–‡æ¡£æŒ‰ç…§æ‹¼éŸ³åˆ†è¯ã€‚åœ¨GitHubä¸Šæ°å¥½æœ‰elasticsearchçš„æ‹¼éŸ³åˆ†è¯æ’ä»¶ã€‚åœ°å€ï¼šhttps://github.com/medcl/elasticsearch-analysis-pinyin ã€‚

<br>

---

<div STYLE="page-break-after: always;">
    <br>
    <br>
    <br>
    <br>
    <br></div>

## 8.2	å®‰è£…æ‹¼éŸ³åˆ†è¯å™¨æ’ä»¶

##### æ­¥éª¤

å¯ä»¥å‚è€ƒIKåˆ†è¯å™¨çš„å®‰è£…è¿‡ç¨‹ã€‚

1. è§£å‹
2. ä¸Šä¼ åˆ°è™šæ‹Ÿæœºä¸­ï¼Œelasticsearchçš„pluginç›®å½•
3. é‡å¯elasticsearch
4. æµ‹è¯•ï¼š

```
POSTÂ /_analyze
{
Â Â "text":Â "å¦‚å®¶é…’åº—è¿˜ä¸é”™",
Â Â "analyzer":Â "pinyin"
}
```

ç»“æœï¼š

![](img/8.2-1.png)

<br>

---

<div STYLE="page-break-after: always;">
    <br>
    <br>
    <br>
    <br>
    <br></div>

## 8.3	è‡ªå®šä¹‰åˆ†è¯å™¨

##### å¯¹æ‹¼éŸ³åˆ†è¯å™¨åšä¸ªæ€§åŒ–å®šåˆ¶

é»˜è®¤çš„æ‹¼éŸ³åˆ†è¯å™¨ä¼šå°†æ¯ä¸ªæ±‰å­—å•ç‹¬åˆ†ä¸ºæ‹¼éŸ³ï¼Œè€Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯æ¯ä¸ªè¯æ¡å½¢æˆä¸€ç»„æ‹¼éŸ³ï¼Œéœ€è¦å¯¹æ‹¼éŸ³åˆ†è¯å™¨åšä¸ªæ€§åŒ–å®šåˆ¶ï¼Œå½¢æˆè‡ªå®šä¹‰åˆ†è¯å™¨ã€‚

<br>

##### elasticsearch ä¸­åˆ†è¯å™¨ï¼ˆanalyzerï¼‰çš„ç»„æˆ

- character filtersï¼šåœ¨tokenizerä¹‹å‰å¯¹æ–‡æœ¬è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚åˆ é™¤å­—ç¬¦ã€æ›¿æ¢å­—ç¬¦
- tokenizerï¼šå°†æ–‡æœ¬æŒ‰ç…§ä¸€å®šçš„è§„åˆ™åˆ‡å‰²æˆè¯æ¡ï¼ˆtermï¼‰ã€‚ä¾‹å¦‚keywordï¼Œå°±æ˜¯ä¸åˆ†è¯ï¼›è¿˜æœ‰ik_smart
- tokenizer filterï¼šå°†tokenizerè¾“å‡ºçš„è¯æ¡åšè¿›ä¸€æ­¥å¤„ç†ã€‚ä¾‹å¦‚å¤§å°å†™è½¬æ¢ã€åŒä¹‰è¯å¤„ç†ã€æ‹¼éŸ³å¤„ç†ç­‰

<br>

##### æ–‡æ¡£åˆ†è¯æ—¶çš„æ–‡æ¡£å¤„ç†è¿‡ç¨‹

![](img/8.3-1.png)

<br>

##### è¯­æ³•â€”å£°æ˜è‡ªå®šä¹‰åˆ†è¯å™¨çš„

```json
PUTÂ /test
{
Â Â "settings":Â {
Â Â Â Â "analysis":Â {
Â Â Â Â Â Â "analyzer":Â {Â //Â è‡ªå®šä¹‰åˆ†è¯å™¨
Â Â Â Â Â Â Â Â "my_analyzer":Â {Â Â //Â åˆ†è¯å™¨åç§°
Â Â Â Â Â Â Â Â Â Â "tokenizer":Â "ik_max_word",
Â Â Â Â Â Â Â Â Â Â "filter":Â "py"
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â },
Â Â Â Â Â Â "filter":Â {Â //Â è‡ªå®šä¹‰tokenizerÂ filter
Â Â Â Â Â Â Â Â "py":Â {Â //Â è¿‡æ»¤å™¨åç§°
Â Â Â Â Â Â Â Â Â Â "type":Â "pinyin",Â //Â è¿‡æ»¤å™¨ç±»å‹ï¼Œè¿™é‡Œæ˜¯pinyin
		  "keep_full_pinyin":Â false,
Â Â Â Â Â Â Â Â Â Â "keep_joined_full_pinyin":Â true,
Â Â Â Â Â Â Â Â Â Â "keep_original":Â true,
Â Â Â Â Â Â Â Â Â Â "limit_first_letter_length":Â 16,
Â Â Â Â Â Â Â Â Â Â "remove_duplicated_term":Â true,
Â Â Â Â Â Â Â Â Â Â "none_chinese_pinyin_tokenize":Â false
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }
Â Â Â Â }
Â Â },
Â Â "mappings":Â {
Â Â Â Â "properties":Â {
Â Â Â Â Â Â "name":Â {
Â Â Â Â Â Â Â Â "type":Â "text",
Â Â Â Â Â Â Â Â "analyzer":Â "my_analyzer",
Â Â Â Â Â Â Â Â "search_analyzer":Â "ik_smart"
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```

<br>

##### æµ‹è¯•

![](img/8.3-2.png)

<br>

##### ğŸ“Œæœç´¢æ—¶ä¸è¦ä½¿ç”¨æ‹¼éŸ³åˆ†è¯å™¨

ä¸ºäº†é¿å…æœç´¢åˆ°åŒéŸ³å­—ï¼Œæœç´¢æ—¶ä¸è¦ä½¿ç”¨æ‹¼éŸ³åˆ†è¯å™¨ã€‚

<br>

---

<div STYLE="page-break-after: always;">
    <br>
    <br>
    <br>
    <br>
    <br></div>

## 8.4	è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢

##### Completion Suggester æŸ¥è¯¢

elasticsearch æä¾›äº† [Completion Suggester](https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html) æŸ¥è¯¢æ¥å®ç°è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚è¿™ä¸ªæŸ¥è¯¢ä¼šåŒ¹é…ä»¥ç”¨æˆ·è¾“å…¥å†…å®¹å¼€å¤´çš„è¯æ¡å¹¶è¿”å›ã€‚ä¸ºäº†æé«˜è¡¥å…¨æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå¯¹äºæ–‡æ¡£ä¸­å­—æ®µçš„ç±»å‹æœ‰ä¸€äº›çº¦æŸï¼š

- å‚ä¸è¡¥å…¨æŸ¥è¯¢çš„å­—æ®µå¿…é¡»æ˜¯ **completion ç±»å‹**ã€‚
- å­—æ®µçš„å†…å®¹ä¸€èˆ¬æ˜¯**ç”¨æ¥è¡¥å…¨çš„å¤šä¸ªè¯æ¡å½¢æˆçš„æ•°ç»„**ã€‚

<br>

##### ä¾‹

æ¯”å¦‚ï¼Œä¸€ä¸ªè¿™æ ·çš„ç´¢å¼•åº“ï¼š

```json
//Â åˆ›å»ºç´¢å¼•åº“
PUTÂ test
{
Â Â "mappings":Â {
Â Â Â Â "properties":Â {
Â Â Â Â Â Â "title":{
Â Â Â Â Â Â Â Â "type":Â "completion"
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```

æ’å…¥ä¸‹é¢çš„æ•°æ®ï¼š

```json
// ç¤ºä¾‹æ•°æ®
POSTÂ test/_doc
{
Â Â "title":Â ["Sony",Â "WH-1000XM3"]
}
POSTÂ test/_doc
{
Â Â "title":Â ["SK-II",Â "PITERA"]
}
POSTÂ test/_doc
{
Â Â "title":Â ["Nintendo",Â "switch"]
}
```

æŸ¥è¯¢çš„ DSL è¯­å¥å¦‚ä¸‹ï¼š

```json
//Â è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢
GETÂ /test/_search
{
Â Â "suggest":Â {
Â Â Â Â "title_suggest":Â {
Â Â Â Â Â Â "text":Â "s",Â //Â å…³é”®å­—
Â Â Â Â Â Â "completion":Â {
Â Â Â Â Â Â Â Â "field":Â "title",Â //Â è¡¥å…¨æŸ¥è¯¢çš„å­—æ®µ
Â Â Â Â Â Â Â Â "skip_duplicates":Â true,Â //Â è·³è¿‡é‡å¤çš„
Â Â Â Â Â Â Â Â "size":Â 10Â //Â è·å–å‰10æ¡ç»“æœ
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```

<br>

---

<div STYLE="page-break-after: always;">
    <br>
    <br>
    <br>
    <br>
    <br></div>

## 8.5	ç¤ºä¾‹â€”å®ç°é…’åº—æœç´¢æ¡†è‡ªåŠ¨è¡¥å…¨

##### å‰æ

ç°åœ¨ï¼Œæˆ‘ä»¬çš„ hotel ç´¢å¼•åº“è¿˜æ²¡æœ‰è®¾ç½®æ‹¼éŸ³åˆ†è¯å™¨ï¼Œéœ€è¦ä¿®æ”¹ç´¢å¼•åº“ä¸­çš„é…ç½®ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ç´¢å¼•åº“æ˜¯æ— æ³•ä¿®æ”¹çš„ï¼Œåªèƒ½åˆ é™¤ç„¶åé‡æ–°åˆ›å»ºã€‚

å¦å¤–ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªå­—æ®µï¼Œç”¨æ¥åšè‡ªåŠ¨è¡¥å…¨ï¼Œå°† brandã€suggestionã€city ç­‰éƒ½æ”¾è¿›å»ï¼Œä½œä¸ºè‡ªåŠ¨è¡¥å…¨çš„æç¤ºã€‚

<br>

##### å¾…åŠäº‹é¡¹

1. ä¿®æ”¹hotelç´¢å¼•åº“ç»“æ„ï¼Œè®¾ç½®è‡ªå®šä¹‰æ‹¼éŸ³åˆ†è¯å™¨
2. ä¿®æ”¹ç´¢å¼•åº“çš„nameã€allå­—æ®µï¼Œä½¿ç”¨è‡ªå®šä¹‰åˆ†è¯å™¨
3. ç´¢å¼•åº“æ·»åŠ ä¸€ä¸ªæ–°å­—æ®µsuggestionï¼Œç±»å‹ä¸ºcompletionç±»å‹ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„åˆ†è¯å™¨
4. ç»™HotelDocç±»æ·»åŠ suggestionå­—æ®µï¼Œå†…å®¹åŒ…å«brandã€business
5. é‡æ–°å¯¼å…¥æ•°æ®åˆ°hotelåº“

<br>

##### ä¿®æ”¹é…’åº—æ˜ å°„ç»“æ„

```
// é…’åº—æ•°æ®ç´¢å¼•åº“
PUT /hotel
{
  "settings": {
    "analysis": {
      "analyzer": {
        "text_anlyzer": {
          "tokenizer": "ik_max_word",
          "filter": "py"
        },
        "completion_analyzer": {
          "tokenizer": "keyword",
          "filter": "py"
        }
      },
      "filter": {
        "py": {
          "type": "pinyin",
          "keep_full_pinyin": false,
          "keep_joined_full_pinyin": true,
          "keep_original": true,
          "limit_first_letter_length": 16,
          "remove_duplicated_term": true,
          "none_chinese_pinyin_tokenize": false
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "id":{
        "type": "keyword"
      },
      "name":{
        "type": "text",
        "analyzer": "text_anlyzer",
        "search_analyzer": "ik_smart",
        "copy_to": "all"
      },
      "address":{
        "type": "keyword",
        "index": false
      },
      "price":{
        "type": "integer"
      },
      "score":{
        "type": "integer"
      },
      "brand":{
        "type": "keyword",
        "copy_to": "all"
      },
      "city":{
        "type": "keyword"
      },
      "starName":{
        "type": "keyword"
      },
      "business":{
        "type": "keyword",
        "copy_to": "all"
      },
      "location":{
        "type": "geo_point"
      },
      "pic":{
        "type": "keyword",
        "index": false
      },
      "all":{
        "type": "text",
        "analyzer": "text_anlyzer",
        "search_analyzer": "ik_smart"
      },
      "suggestion":{
          "type": "completion",
          "analyzer": "completion_analyzer"
      }
    }
  }
}
```

<br>

##### ä¿®æ”¹ HotelDoc å®ä½“

HotelDocä¸­è¦æ·»åŠ ä¸€ä¸ªå­—æ®µï¼Œç”¨æ¥åšè‡ªåŠ¨è¡¥å…¨ï¼Œå†…å®¹å¯ä»¥æ˜¯é…’åº—å“ç‰Œã€åŸå¸‚ã€å•†åœˆç­‰ä¿¡æ¯ã€‚æŒ‰ç…§è‡ªåŠ¨è¡¥å…¨å­—æ®µçš„è¦æ±‚ï¼Œæœ€å¥½æ˜¯è¿™äº›å­—æ®µçš„æ•°ç»„ã€‚

å› æ­¤æˆ‘ä»¬åœ¨HotelDocä¸­æ·»åŠ ä¸€ä¸ªsuggestionå­—æ®µï¼Œç±»å‹ä¸º`List<String>`ï¼Œç„¶åå°†brandã€cityã€businessç­‰ä¿¡æ¯æ”¾åˆ°é‡Œé¢ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```
package cn.itcast.hotel.pojo;

import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

@Data
@NoArgsConstructor
public class HotelDoc {
    private Long id;
    private String name;
    private String address;
    private Integer price;
    private Integer score;
    private String brand;
    private String city;
    private String starName;
    private String business;
    private String location;
    private String pic;
    private Object distance;
    private Boolean isAD;
    private List<String> suggestion;

    public HotelDoc(Hotel hotel) {
        this.id = hotel.getId();
        this.name = hotel.getName();
        this.address = hotel.getAddress();
        this.price = hotel.getPrice();
        this.score = hotel.getScore();
        this.brand = hotel.getBrand();
        this.city = hotel.getCity();
        this.starName = hotel.getStarName();
        this.business = hotel.getBusiness();
        this.location = hotel.getLatitude() + ", " + hotel.getLongitude();
        this.pic = hotel.getPic();
        // ç»„è£…suggestion
        if(this.business.contains("/")){
            // businessæœ‰å¤šä¸ªå€¼ï¼Œéœ€è¦åˆ‡å‰²
            String[] arr = this.business.split("/");
            // æ·»åŠ å…ƒç´ 
            this.suggestion = new ArrayList<>();
            this.suggestion.add(this.brand);
            Collections.addAll(this.suggestion, arr);
        }else {
            this.suggestion = Arrays.asList(this.brand, this.business);
        }
    }
}
```

<br>

##### é‡æ–°å¯¼å…¥

é‡æ–°æ‰§è¡Œä¹‹å‰ç¼–å†™çš„å¯¼å…¥æ•°æ®åŠŸèƒ½ï¼Œå¯ä»¥çœ‹åˆ°æ–°çš„é…’åº—æ•°æ®ä¸­åŒ…å«äº†suggestionï¼š

<br>

##### è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢çš„ JavaAPI

ç¤ºä¾‹ï¼š

![image-20210723213759922](img/8.4-1.png)

è€Œè‡ªåŠ¨è¡¥å…¨çš„ç»“æœä¹Ÿæ¯”è¾ƒç‰¹æ®Šï¼Œè§£æçš„ä»£ç å¦‚ä¸‹ï¼š

![image-20210723213917524](img/8.4-2.png)

<br>

##### å®ç°æœç´¢æ¡†è‡ªåŠ¨è¡¥å…¨

æŸ¥çœ‹å‰ç«¯é¡µé¢ï¼Œå¯ä»¥å‘ç°å½“æˆ‘ä»¬åœ¨è¾“å…¥æ¡†é”®å…¥æ—¶ï¼Œå‰ç«¯ä¼šå‘èµ· ajax è¯·æ±‚ï¼š

![image-20210723214021062](img/8.4-3.png)

è¿”å›å€¼æ˜¯è¡¥å…¨è¯æ¡çš„é›†åˆï¼Œç±»å‹ä¸º `List<String>`

###### æ­¥éª¤

1. åœ¨`cn.itcast.hotel.web`åŒ…ä¸‹çš„`HotelController`ä¸­æ·»åŠ æ–°æ¥å£ï¼Œæ¥æ”¶æ–°çš„è¯·æ±‚ï¼š

```java
@GetMapping("suggestion")
public List<String> getSuggestions(@RequestParam("key") String prefix) {
    return hotelService.getSuggestions(prefix);
}
```

2. åœ¨`cn.itcast.hotel.service`åŒ…ä¸‹çš„`IhotelService`ä¸­æ·»åŠ æ–¹æ³•ï¼š

```java
List<String> getSuggestions(String prefix);
```

3. åœ¨`cn.itcast.hotel.service.impl.HotelService`ä¸­å®ç°è¯¥æ–¹æ³•ï¼š

```java
@Override
public List<String> getSuggestions(String prefix) {
    try {
        // 1.å‡†å¤‡Request
        SearchRequest request = new SearchRequest("hotel");
        // 2.å‡†å¤‡DSL
        request.source().suggest(new SuggestBuilder().addSuggestion(
            "suggestions",
            SuggestBuilders.completionSuggestion("suggestion")
            .prefix(prefix)
            .skipDuplicates(true)
            .size(10)
        ));
        // 3.å‘èµ·è¯·æ±‚
        SearchResponse response = client.search(request, RequestOptions.DEFAULT);
        // 4.è§£æç»“æœ
        Suggest suggest = response.getSuggest();
        // 4.1.æ ¹æ®è¡¥å…¨æŸ¥è¯¢åç§°ï¼Œè·å–è¡¥å…¨ç»“æœ
        CompletionSuggestion suggestions = suggest.getSuggestion("suggestions");
        // 4.2.è·å–options
        List<CompletionSuggestion.Entry.Option> options = suggestions.getOptions();
        // 4.3.éå†
        List<String> list = new ArrayList<>(options.size());
        for (CompletionSuggestion.Entry.Option option : options) {
            String text = option.getText().toString();
            list.add(text);
        }
        return list;
    } catch (IOException e) {
        throw new RuntimeException(e);
    }
}
```

<br>

---

<div STYLE="page-break-after: always;">
    <br>
    <br>
    <br>
    <br>
    <br></div>

